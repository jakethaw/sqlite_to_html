<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>SQLite to HTML</title>
    <style>
      td {
          vertical-align: top;
          padding-bottom: 5px;
          padding-right: 20px;
      }
    </style>
  </head>
  <body>
    <h1>SQLite to HTML</h1>
    
    <a href="https://github.com/jakethaw/sqlite_to_html">github.com/jakethaw/sqlite_to_html</a>
    
    <br>
    <br>

    <select name="file" id="file" onchange="select_file()">
      <option value="graph.sql">graph.sql</option>
      <option value="affine.sql">affine.sql</option>
      <option value="dragon.sql">dragon.sql</option>
      <option value="serpinski.sql">serpinski.sql</option>
      <option value="cubes.sql">cubes.sql</option>
    </select>
    
    <table>
      <tr>
        <td>
          <textarea id="sql" wrap="off" rows="35" cols="80"></textarea>
          <br>
          <div id="error" style="color:red">error</div>
        </td>
        <td>
          <div id="svg"></div>
        </td>
      </tr>
    </table>

    <script>

      var timer = 0;
      var file = document.getElementById("file").value;
      var eval_wait = 0;

      var Module = {
        // onRuntimeInitialized: function() { 
        //   select_file();
        //   // // Evaluate every 30ms
        //   // setInterval(eval_sql, 30); 
        // },
        noInitialRun: true,
        printErr: function(text) { document.getElementById("error").innerText += text + '\n'; }
      };

      // Run content of textarea in SQLite CLI
      function eval_sql(){
        if( eval_wait == 0 ){
          eval_wait = 1;
          const sql = document.getElementById("sql").value;
          FS.writeFile(file, sql);
          document.getElementById("error").innerText = '';
          callMain([':memory:', '.param init', `.param set $timer ${timer}`, `.read ${file}`]);
          document.getElementById('svg').innerHTML = FS.readFile('output.svg', { encoding: 'utf8' });
          eval_wait = 0;
        }
        timer += 1;
      }

      function select_file(){
        var e = document.getElementById("file");
        file = e.options[e.selectedIndex].value;
        timer = 0;

        // Get file
        fetch(file)
          .then(response => response.text())
          .then(data => {
            document.getElementById("sql").value = data;
            FS.writeFile(file, data);
          });
      }

      var runDependencies = 1;
      function wait_load(){
        if(runDependencies == 0 && __ATPRERUN__.length == 0){
          select_file();
          setInterval(eval_sql, 30);
        }else{
          setTimeout(wait_load, 50);
        }
      }
      wait_load();

    </script>
    <script type="text/javascript" src="sqlite3.js"></script>

  </body>
</html>


